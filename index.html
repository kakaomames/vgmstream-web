<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <meta name="description" content="Gemini programmingéšŠ - vgmstreamè§£æãƒŸãƒƒã‚·ãƒ§ãƒ³">
    <meta property="og:image" content="https://kakaomames.github.io/rei/logo.png">
    <title>vgmstream Master | Gemini programmingéšŠ ğŸ›°ï¸</title>
    <script src="js/soundbuffer.js"></script>
    <script src="js/custom-audio.js"></script>
    <script src="js/player.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #1a1a1a; color: #eee; text-align: center; padding: 20px; }
        .panel { background: #252525; border: 2px solid #5b9d2f; border-radius: 12px; padding: 25px; display: inline-block; width: 90%; max-width: 700px; text-align: left; }
        .logo { width: 50px; vertical-align: middle; }
        
        /* ã‚ã®ç·‘ã®å…‰ã‚‹ãƒãƒ¼ã‚’ã“ã“ã§ã‚‚æ¡ç”¨ï¼ */
        .progress-container { width: 100%; height: 20px; background: #333; border: 1px solid #555; overflow: hidden; margin: 15px 0; }
        .progress-bar { 
            height: 100%; width: 0%; 
            background: linear-gradient(to bottom, #b7e8b7 0%, #5b9d2f 50%, #3e6d1f 100%);
            position: relative; transition: width 0.3s;
        }
        .progress-bar::after {
            content: ""; position: absolute; top: 0; left: 0; bottom: 0; right: 0;
            background-image: linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,0.3) 50%, rgba(255,255,255,0) 100%);
            background-size: 200px 100%; animation: moveLight 2s infinite linear;
        }
        @keyframes moveLight { from { background-position: -200px 0; } to { background-position: 100% 0; } }

        .btn { background: #5b9d2f; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        #log { font-size: 11px; background: #000; padding: 10px; height: 80px; overflow-y: auto; color: #0f0; margin-top: 10px; }
    </style>
</head>
<body>

    <div class="panel">
        <h2><img src="https://kakaomames.github.io/rei/logo.png" class="logo"> vgmstream è§£æãƒŸãƒƒã‚·ãƒ§ãƒ³</h2>
        <p style="font-size: 0.8em; color: #888;">fsb, wem, adx ç­‰ã®ç‰¹æ®Šãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’è§£èª­ãƒ»çµ±åˆã—ã¾ã™ã€‚</p>

        <input type="file" id="browse" multiple>
        
        <div class="progress-container">
            <div id="progressBar" class="progress-bar"></div>
        </div>

        <div id="statusText" style="font-size: 0.9em;">å¾…æ©Ÿä¸­...</div>
        <div id="log"></div>

        <hr style="border: 0.5px solid #444; margin: 20px 0;">
        
        <button id="startBtn" class="btn" onclick="startVgmstreamProcess()">è§£èª­ãƒ»çµ±åˆé–‹å§‹ ğŸš€</button>
        <custom-audio id="audio" controls style="width: 100%; margin-top: 15px;"></custom-audio>
    </div>
<script src="js/soundbuffer.js"></script>
<script src="js/custom-audio.js"></script>
<script src="js/player.js"></script>
    <script>
        const log = (msg) => {
            const div = document.getElementById('log');
            div.innerHTML += `> ${msg}<br>`;
            div.scrollTop = div.scrollHeight;
            document.getElementById('statusText').innerText = msg;
        };

        const updateBar = (percent) => {
            document.getElementById('progressBar').style.width = `${percent * 100}%`;
        };

        async function startVgmstreamProcess() {
            const input = document.getElementById('browse');
            if (input.files.length === 0) return alert("ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸ã‚“ã§ï¼éšŠå“¡ï¼");
            
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            let allBuffers = [];
            const files = Array.from(input.files);

            log("ğŸš€ ãƒŸãƒƒã‚·ãƒ§ãƒ³é–‹å§‹ï¼šWorkerã‚’å‘¼ã³å‡ºã—ã¦ã„ã¾ã™...");

            for (let fIdx = 0; fIdx < files.length; fIdx++) {
                const file = files[fIdx];
                log(`ğŸ“„ è§£æä¸­: ${file.name}`);

                const arrayBuffer = await file.arrayBuffer();
                await cliWorker.send("writeFile", file.name, new Uint8Array(arrayBuffer));

                // ã‚¹ãƒˆãƒªãƒ¼ãƒ æ•°ã‚’ç¢ºèª (-m)
                const info = await cliWorker.send("vgmstream", "-m", "-i", file.name);
                const streamMatch = info.stdout.match(/Stream index: \d+ \/ (\d+)/);
                let totalStreams = streamMatch ? parseInt(streamMatch[1]) : 1;

                log(`âœ… ${totalStreams} å€‹ã®éŸ³å£°ã‚’æ¤œå‡ºã€‚æŠ½å‡ºä¸­...`);

                for (let i = 1; i <= totalStreams; i++) {
                    const outName = `temp_${fIdx}_${i}.wav`;
                    // 1ã¤ãšã¤æ•‘å‡º
                    await cliWorker.send("vgmstream", "-s", i.toString(), "-i", file.name, "-o", outName);
                    
                    const wavData = await cliWorker.send("readFile", outName);
                    if (wavData) {
                        const buffer = await audioCtx.decodeAudioData(wavData.buffer);
                        allBuffers.push(buffer);
                    }
                    await cliWorker.send("deleteFile", outName);
                    
                    // é€²æ—è¨ˆç®—
                    const progress = (fIdx / files.length) + ((i / totalStreams) * (1 / files.length));
                    updateBar(progress);
                }
                await cliWorker.send("deleteFile", file.name);
            }

            // é€£çµå‡¦ç†
            if (allBuffers.length > 0) {
                log("ğŸ”— å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’é€£çµã—ã¦çµ±åˆWAVã‚’ç”Ÿæˆä¸­...");
                const finalBuffer = mergeBuffers(audioCtx, allBuffers);
                const wavBlob = bufferToWav(finalBuffer); // å‰ã«ä½œã£ãŸé–¢æ•°ã‚’ã“ã“ã«å…¥ã‚Œã‚‹
                
                const url = URL.createObjectURL(wavBlob);
                document.getElementById('audio').src = url;

                // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                const a = document.createElement("a");
                a.href = url;
                a.download = `vgmstream_merged.wav`;
                a.target = "_blank";
                a.click();
            }
            updateBar(1);
            log("ğŸ ãƒŸãƒƒã‚·ãƒ§ãƒ³å®Œäº†ï¼");
        }

        function mergeBuffers(ctx, buffers) {
            let totalLen = buffers.reduce((a, b) => a + b.length, 0);
            let final = ctx.createBuffer(buffers[0].numberOfChannels, totalLen, buffers[0].sampleRate);
            for (let ch = 0; ch < final.numberOfChannels; ch++) {
                let offset = 0;
                for (const b of buffers) {
                    final.getChannelData(ch).set(b.getChannelData(ch), offset);
                    offset += b.length;
                }
            }
            return final;
        }

        // â€» bufferToWavé–¢æ•°ï¼ˆå‰è¿°ã®ã‚‚ã®ï¼‰ã‚’ã“ã“ã«è¿½åŠ ã—ã¦ãã ã•ã„
    </script>
</body>
</html>









<!--
<link rel="stylesheet" href="css/player.css">
<link rel="stylesheet" href="css/player-dark.css" media="(prefers-color-scheme: dark)">
<script src="js/dark-toggle.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
</head>
<body>
<main>
	<header><h2>vgmstream-web</h2></header>
	<input type="file" multiple id="browse">
	<input type="file" webkitdirectory id="browsedir">
	<div id="buttons" data-nosnippet>
		<button class="greenbutton" id="selectbtn">Select or drop an audio stream file here...</button>
		<button class="greenbutton" id="selectdirbtn">Folder</button>
	</div>
	<noscript><div data-nosnippet>This page requires JavaScript to be enabled in your browser.</div></noscript>
	<div id="wasmwarning" data-nosnippet>This page requires WebAssembly to be enabled in your browser.</div>
	<div id="directorybox">
		<form>
			<select id="dirselect" size="2"></select>
			<div><input id="dirselectbtn" class="button" type="submit" value="Select"></div>
		</form>
	</div>
	<div id="audiobox">
		<div id="filenamebox"></div>
		<div><custom-audio id="audio" controls></custom-audio></div>
		<div><input id="download" class="button" type="button" value="Download"></div>
		<div id="logbox">
			<a id="logdropdown" tabindex="0">vgmstream output</a>
			<div id="log"></div>
		</div>
	</div>
</main>
<div id="footer" data-nosnippet>
	<ul>
		<li><a href="https://github.com/vgmstream/vgmstream">vgmstream</a></li>
		<li><a href="https://github.com/KatieFrogs">Katie Frogs</a></li>
		<li>
			<a id="darktoggle" tabindex="0">Dark theme</a>
			<a id="darkreset" tabindex="0" title="Reset">(x)</a>
		</li>
	</ul>
</footer>
<div id="fadeoverlay" data-nosnippet>...</div>
<script src="js/soundbuffer.js"></script>
<script src="js/custom-audio.js"></script>
<script src="js/player.js"></script>
</body>
</html>
-->
